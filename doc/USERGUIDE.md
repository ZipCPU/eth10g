# KlusterLab User Guide

The following contains a brief overview of how to build, load, and use the
KlusterLab board and this 10Gb Ethernet router design.  Further documentation
may often be found in the user guides associated with the various components
on the board, found in the repositories of those separate components.

## Design Build

To reconfigure the design via AutoFPGA, adjust the component list found in the
[AutoFPGA Makefile](../autodata/Makefile), run `make autodata` in the master
directory, and then do a full rebuild.  AutoFPGA does not need to be run,
however, since all of its products should already be found in the repository
as is.

No further special build instructions are required.  This IP does not use any
Vivado or other proprietary components not licensed herein.  FPGA
Configurations may be created using your Kintex-7 tool of choice.  The top
level design file may be found [here](../rtl/toplevel.v), and the top level
constraints file may be found [here](../rtl/board.xdc).  Both files are
produced via AutoFPGA, and may be adjusted by adding or removing component
descriptions from the [AutoFPGA Makefile](../autodata/Makefile) if necessary.

## Software build

The support software for this board may be found in the sw/ directory.  It
exists in three parts: host software, I2C scripts, and ZipCPU software.
Host software may be built by running `make sw-host` from the main directory.
I2C scripts may be built by running `make sw-i2c` from the main directory.
I2C scripts require the i2casm software, found in the ZipCPU wbi2c repository.
ZipCPU software may be built by running `make sw-board` from the main
directory.  ZipCPU software requires the ZipCPU tool chain, found in the master
ZipCPU repository.

## Board Configuration

Bit/Configuration files may be loaded onto the board via `openFPGALoader`.

## Board Interaction

All interaction with the FPGA design is accomplished via the RPi, using the
[devbus](../sw/host/devbus.h) interface.  To set it up, however, you will first
need to build and then run [netuart](../sw/host/netuart.cpp).  `netuart` will
establish a serial port connection to the board, and then forward that
connection over a pair of TCP/IP links.  The first link runs the `devbus`
protocol, operating from the RPi on port 8845.  The second link is a console
port which can be used to interact with the CPU.  This takes place on port
8846.

Programs of particular interest include:

- wbregs: The primary low-level means of interacting with the board is
  [wbregs](../sw/host/wbregs.cpp).  To use it, run `wbregs` with an
  address, to read a value from the system bus, or both an address and
  a value, to write the value to the given address on the system bus.

  All of the FPGAs hardware configuration register, memory, CPU block RAM,
  may be read and accessed via this program.

  Registers may also be accessed by name, and not just address.  The
  register name to address mapping is generated by AutoFPGA, and may be found
  in the [regdefs.cpp](../sw/host/regdefs.cpp) file.

- [zipload](../sw/host/zipload.cpp): This program is used to load ZipCPU
  programs into memory.  It can also be used to load FPGA configurations onto
  the flash.  It takes up to three arguments: the main bitfile, an
  (optional) alternate bit file, and a ZipCPU executable.  Either the
  alternate bitfile or both bitfiles may be skipped.

  This ZipCPU loader depends upon the [flash driver](../sw/host/flashdrvr.cpp),
  also found in the same directory.  This allows ZipCPU programs to be loaded
  directly onto flash.

- xScope: A variety of `*scope.cpp` programs exist in the host software
  directory.  These can be used to read from a Wishbone scope built into
  the design.  The scope may be reset and then configured via `wbregs`.
  The scope programs will then read any data captured by the scope, and
  create a `*.vcd` file from it for viewing.

## ZipCPU Software

This board has been demonstrated using a variety of ZipCPU programs, each of
which may be loaded on the board individually.  These programs are:

- [hello](../sw/zipcpu/board/hello.c): A basic Hello World program.  The ZipCPU
  will print "Hello World" to the console and exit.

- [cputest](../sw/zipcpu/board/cputest.c): A ZipCPU internal testing program,
  used to help verify that the CPU works in its current configuration.

- [ssddemo](../sw/zipcpu/board/ssddemo.c): Can be used to load an image on the
  OLED display.  The image, built via `i2casm`, can be found encoded in
  `ssdlogo.c`.

- [sdinfo](../sw/zipcpu/board/sdinfo.c): Attempts to interact with an SD card.
  This includes a full read of the cards registers, followed by an attempt to
  read the main directory.  If everything works, a list of files in the main
  directory of the SD card will be printed on the ZipCPU console.

  A lower level access program used for testing the port, may be found in
  [sdiochk](../sw/zipcpu/board/sdiochk.c).

- [emmcinfo](../sw/zipcpu/board/emmcinfo.c): This program is identical to the
  `sdinfo` program, save that it interacts with the eMMC chip on the board
  instead of any SD card that may (or may not) have been plugged in.

- [rdramcfg](../sw/zipcpu/board/rdramcfg.c): Reads the DDR3 SDRAM configuration
  over the I2C port, and dumps it over the ZipCPU console.

- [rdsfp](../sw/zipcpu/board/rdsfp.c): Reads the configuration information from
  the various SFP+ (10Gb Ethernet) ports via I2C.  The information is then
  dumped over the ZipCPU console.

- [sisetup](../sw/zipcpu/board/sisetup.c): Sets up the Si5324's clock output,
  so that it will produce a 148.5 MHz output.  This can then be used by the
  HDMI video generator.

- [clkcheck](../sw/zipcpu/board/clkcheck.c): Runs a program that reads the
  clock frequencies internal to the design, and dumps them periodically over
  the ZipCPU console port.

- [rxhdmi](../sw/zipcpu/board/rxhdmi.c): Sets up the HDMI port.  Once setup,
  this port will forward an incoming HDMI image (from the RPi) to the HDMI
  output port.  This includes reading the downstream EDID information and
  forwarding it upstream.

- [memtest](../sw/zipcpu/board/memtest.c): Tests whether or not the memory
  works.  The test will run until either the ZipCPU is interrupted or an error
  is encountered.  While running, the LEDs will toggle and flash, letting you
  know where in the sequence it is at.  Barring any other circumstance, if the
  LEDs stop changing than a memory error was encountered.  (Other reasons might
  include a power failure, FPGA reconfiguration, ZipCPU halt command, etc.)

- [netcheck](../sw/zipcpu/board/netcheck.c): This program assigns memory
  addresses to the various network ports within the design.  It must be run
  before the KlusterLab board will be able to route high speed 10Gb
  Ethernet packets from one port to the next.

## Simulations

An integrated Verilator based simulation may be found in the [sim](../sim)
directory.  Although integrated, this simulation is missing models for both
the DDR3 memory and the 10Gb Ethernet links.  Models exist for the flash,
HDMI, and SDIO/SPI devices.

A 10Gb network simulation exists in the [bench/rtl](../bench/rtl) directory.
This is an all Verilog simulation, designed to test and check the GTX
transceiver implementation used by the design, and depends therefore upon
Xilinx's simulation models for these transceivers.  This simulation, however,
only tests the network portions of the design.

## Formal Proofs

Many of the components of this design can be formally verified.  You will need
to have SymbiYosys installed, together with the Yices2 theorem prover.  To
re-run the proofs, run `make -k` in the [bench/formal](../bench/formal)
directory.
